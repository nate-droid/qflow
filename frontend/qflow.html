<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantumWorkflow Visualizer</title>

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        :root {
            --brand-color: #4f46e5; /* indigo-600 */
            --brand-color-hover: #4338ca; /* indigo-700 */
            --bg-primary: #0f172a; /* slate-900 */
            --bg-secondary: #1e293b; /* slate-800 */
            --bg-tertiary: #334155; /* slate-700 */
            --border-primary: #334155;
            --border-secondary: #475569; /* slate-600 */
            --text-primary: #e2e8f0; /* slate-200 */
            --text-secondary: #94a3b8; /* slate-400 */
            --text-accent: #818cf8; /* indigo-400 */
        }
        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .font-code { font-family: 'Fira Code', monospace; }

        #cy { height: 100%; width: 100%; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-secondary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; } /* slate-500 */

        /* Modal Styles */
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center; z-index: 100;
            opacity: 0; transition: opacity 0.2s ease-in-out;
        }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal-content {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            padding: 1.5rem; border-radius: 0.5rem;
            width: 90%; max-width: 800px; max-height: 90vh;
            display: flex; flex-direction: column;
            transform: scale(0.95); opacity: 0;
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); opacity: 1; }
        .modal-content h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; }
        .modal-close-btn {
            position: absolute; top: 0.75rem; right: 0.75rem; color: var(--text-secondary);
            cursor: pointer; background: none; border: none; font-size: 1.5rem; line-height: 1;
        }
        .modal-close-btn:hover { color: var(--text-primary); }

        /* Button Styles */
        .btn { transition: background-color 0.2s; }
        .btn-primary { background-color: var(--brand-color); color: white; font-weight: 500; padding: 0.625rem 1rem; border-radius: 0.375rem; text-align: center; cursor: pointer; }
        .btn-primary:hover:not(:disabled) { background-color: var(--brand-color-hover); }
        .btn-primary:disabled { background-color: #374151; cursor: not-allowed; }
        .btn-success { background-color: #16a34a; color: white; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.375rem; text-align: center; cursor: pointer; }
        .btn-success:hover { background-color: #15803d; }

        /* D3 Chart Styles */
        #q-state-vis-container { background-color: #020617; border-radius: 0.5rem; padding: 1.5rem 1rem 1rem 0; } /* slate-950 */
        .vis-bar { fill: var(--text-accent); transition: fill 0.2s; }
        .vis-bar:hover { fill: #a5b4fc; } /* indigo-300 */
        .vis-axis path, .vis-axis line { stroke: var(--border-secondary); }
        .vis-axis text { fill: var(--text-secondary); font-family: 'Fira Code', monospace; font-size: 0.75rem; }
        .vis-grid line { stroke: var(--border-primary); stroke-opacity: 0.7; shape-rendering: crispEdges; }
        .vis-grid path { stroke-width: 0; }

        /* Navigation */
        .nav-link {
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }
        .nav-link.active {
            color: var(--brand-color);
            border-bottom-color: var(--brand-color);
        }

    </style>
</head>
<body class="h-full">
<div class="flex flex-col h-screen bg-slate-900">
    <!-- Header -->
    <header class="bg-slate-900/70 backdrop-blur-sm border-b border-slate-700/80 p-4 shadow-lg z-20 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-8">
            <h1 class="text-xl font-bold text-white">QuantumWorkflow</h1>
            <nav class="flex items-center gap-6 text-sm font-medium text-slate-400">
                <a href="#" id="nav-visualizer" class="nav-link active">Visualizer</a>
                <a href="#" id="nav-submitter" class="nav-link">Submit QASM</a>
            </nav>
        </div>
        <div id="polling-status" class="text-sm text-slate-400 items-center gap-2 hidden">
            <svg class="animate-spin h-4 w-4 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span class="hidden md:inline">Polling for updates...</span>
        </div>
    </header>

    <!-- Main Content -->
    <main id="visualizer-page" class="flex-1 flex overflow-hidden">
        <div id="cy-container" class="flex-1 relative">
            <div id="cy"></div>
            <!-- Initial Fetch Overlay -->
            <div id="graph-overlay" class="absolute inset-0 bg-slate-900/80 flex items-center justify-center z-30 transition-opacity duration-300">
                <div class="w-full max-w-md p-4 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l-2.293-2.293a1 1 0 010-1.414l7-7a1 1 0 011.414 0l7 7a1 1 0 010 1.414L15 21m-5-5h2m-1-4V5" /></svg>
                    <h2 class="mt-2 text-2xl font-bold text-white mb-2">Fetch a Workflow</h2>
                    <p class="text-slate-400 mb-6">Enter the name and namespace of a workflow to visualize its graph.</p>
                    <div class="flex flex-col sm:flex-row gap-3 mb-4">
                        <input type="text" id="workflow-input" class="bg-slate-800 border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500 rounded-md py-2 px-3 text-white w-full" placeholder="Workflow Name" value="my-quantum-workflow">
                        <input type="text" id="namespace-input" class="bg-slate-800 border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500 rounded-md py-2 px-3 text-white w-full" placeholder="Namespace" value="default">
                    </div>
                    <button id="fetch-button" class="btn btn-primary w-full">Fetch & Visualize</button>
                </div>
            </div>
        </div>
        <!-- Details Panel -->
        <aside id="details-panel" class="w-full md:w-1/3 lg:w-1/4 bg-slate-800/80 backdrop-blur-sm border-l border-slate-700/80 flex flex-col transition-all">
            <div class="p-6 overflow-y-auto flex-1">
                <div id="details-content" class="transition-opacity duration-300 opacity-100">
                    <h2 id="details-title" class="text-xl font-bold text-white mb-6">Status: <span id="workflow-name-display" class="text-indigo-400 font-semibold">Idle</span></h2>
                    <!-- Placeholder shown when no task is selected -->
                    <div id="details-placeholder" class="text-center text-slate-400 pt-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-10 w-10 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>
                        <p class="mt-2">Select a task node from the graph to view its details here.</p>
                        <p id="details-fetch-prompt" class="mt-4 text-sm text-slate-500 hidden">Fetch a workflow to begin.</p>
                    </div>
                    <!-- Data shown when a task is selected -->
                    <div id="details-data" class="hidden space-y-5">
                        <!-- Status Card -->
                        <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                            <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                Status
                            </h3>
                            <p id="details-status" class="font-code text-sm font-semibold"></p>
                        </div>
                        <!-- Circuit/Command Card -->
                        <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                            <h3 id="details-circuit-title" class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V3m0 18v-3" /></svg>
                                Circuit (OpenQASM)
                            </h3>
                            <pre class="bg-slate-950 rounded-md p-3 text-sm font-code text-indigo-300 overflow-x-auto"><code id="details-circuit"></code></pre>
                        </div>
                        <!-- Parameters Card -->
                        <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                            <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                Parameters
                            </h3>
                            <pre class="bg-slate-950 rounded-md p-3 text-sm font-code text-amber-300 overflow-x-auto"><code id="details-params"></code></pre>
                        </div>
                        <div id="results-button-container" class="pt-2"></div>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <main id="qasm-submitter-page" class="flex-1 overflow-y-auto p-8 hidden">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold text-white mb-2">Submit OpenQASM Workflow</h2>
            <p class="text-slate-400 mb-6">Paste your OpenQASM 2.0 code below to create and run a new workflow.</p>

            <div id="qasm-notification" class="hidden p-4 mb-4 rounded-md"></div>

            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="qasm-workflow-name" class="block text-sm font-medium text-slate-300 mb-1">Workflow Name</label>
                        <input type="text" id="qasm-workflow-name" class="bg-slate-800 border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500 rounded-md py-2 px-3 text-white w-full" placeholder="e.g., my-bell-state-exp">
                    </div>
                    <div>
                        <label for="qasm-namespace" class="block text-sm font-medium text-slate-300 mb-1">Namespace</label>
                        <input type="text" id="qasm-namespace" class="bg-slate-800 border border-slate-600 focus:ring-indigo-500 focus:border-indigo-500 rounded-md py-2 px-3 text-white w-full" value="default">
                    </div>
                </div>
                <div>
                    <label for="qasm-input" class="block text-sm font-medium text-slate-300 mb-1">OpenQASM 2.0 Code</label>
                    <textarea id="qasm-input" rows="15" class="w-full bg-slate-950 border border-slate-600 rounded-md p-3 font-code text-indigo-300 focus:ring-indigo-500 focus:border-indigo-500" placeholder="OPENQASM 2.0;&#ninclude &quot;qelib1.inc&quot;;&#n&#10;qreg q[2];&#10;creg c[2];&#10;&#10;h q[0];&#10;cx q[0], q[1];&#10;measure q -> c;"></textarea>
                </div>
                <div class="flex justify-end">
                    <button id="qasm-submit-button" class="btn btn-primary">Submit Workflow</button>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Modals -->
<div id="error-modal-overlay" class="modal-overlay">
    <div id="error-modal-content" class="modal-content" onclick="event.stopPropagation()"></div>
</div>

<div id="results-modal-overlay" class="modal-overlay">
    <div id="results-modal-content" class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close-btn" onclick="closeModal('results-modal-overlay')">&times;</button>
        <h2 id="results-modal-title" class="text-indigo-400 shrink-0">Task Results</h2>
        <!-- Tabs -->
        <div class="border-b border-slate-600 mb-4 shrink-0">
            <nav id="results-tabs" class="-mb-px flex space-x-6" aria-label="Tabs">
                <a href="#" id="tab-vis" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-400">State Vector</a>
                <a href="#" id="tab-log" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-400">Raw Log</a>
            </nav>
        </div>
        <div class="flex-1 overflow-y-auto">
            <div id="q-state-vis-container" class="">
                <h3 class="text-sm font-semibold text-slate-400 mb-2">State Vector Probabilities</h3>
                <div id="q-state-vis" class="w-full h-72"></div>
            </div>
            <div id="raw-log-container" class="hidden">
                <pre><code id="results-modal-log" class="font-code text-sm"></code></pre>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Globals ---
        let currentWorkflow = null;
        let pollingTimeoutId = null;

        // --- DOM Elements ---
        const dom = {
            nav: {
                visualizer: document.getElementById('nav-visualizer'),
                submitter: document.getElementById('nav-submitter'),
            },
            pages: {
                visualizer: document.getElementById('visualizer-page'),
                submitter: document.getElementById('qasm-submitter-page'),
            },
            graphOverlay: document.getElementById('graph-overlay'),
            fetchButton: document.getElementById('fetch-button'),
            workflowInput: document.getElementById('workflow-input'),
            namespaceInput: document.getElementById('namespace-input'),
            workflowNameDisplay: document.getElementById('workflow-name-display'),
            pollingStatus: document.getElementById('polling-status'),
            details: {
                content: document.getElementById('details-content'),
                placeholder: document.getElementById('details-placeholder'),
                fetchPrompt: document.getElementById('details-fetch-prompt'),
                data: document.getElementById('details-data'),
                title: document.getElementById('details-title'),
                status: document.getElementById('details-status'),
                circuitTitle: document.getElementById('details-circuit-title'),
                circuit: document.getElementById('details-circuit'),
                params: document.getElementById('details-params'),
                resultsBtnContainer: document.getElementById('results-button-container'),
            },
            qasm: {
                notification: document.getElementById('qasm-notification'),
                nameInput: document.getElementById('qasm-workflow-name'),
                namespaceInput: document.getElementById('qasm-namespace'),
                input: document.getElementById('qasm-input'),
                submitButton: document.getElementById('qasm-submit-button'),
            },
            errorModal: {
                overlay: document.getElementById('error-modal-overlay'),
                content: document.getElementById('error-modal-content'),
            },
            resultsModal: {
                overlay: document.getElementById('results-modal-overlay'),
                title: document.getElementById('results-modal-title'),
                logContainer: document.getElementById('raw-log-container'),
                log: document.getElementById('results-modal-log'),
                visContainer: document.getElementById('q-state-vis-container'),
                vis: document.getElementById('q-state-vis'),
                tabVis: document.getElementById('tab-vis'),
                tabLog: document.getElementById('tab-log'),
            }
        };

        // --- Initial State ---
        dom.details.fetchPrompt.classList.remove('hidden');

        // --- Page Navigation ---
        function showPage(pageName) {
            Object.values(dom.pages).forEach(p => p.classList.add('hidden'));
            Object.values(dom.nav).forEach(n => n.classList.remove('active'));

            if (pageName === 'visualizer') {
                dom.pages.visualizer.classList.remove('hidden');
                dom.nav.visualizer.classList.add('active');
            } else if (pageName === 'submitter') {
                dom.pages.submitter.classList.remove('hidden');
                dom.nav.submitter.classList.add('active');
            }
        }

        // --- Modal Logic ---
        function showModal(modal, title, content) {
            modal.content.innerHTML = `
                <button class="modal-close-btn" onclick="closeModal('${modal.overlay.id}')">&times;</button>
                <h2 style="color: #f87171;">${title}</h2>
                <div>${content}</div>`;
            modal.overlay.classList.add('visible');
        }
        window.closeModal = (overlayId) => {
            const overlay = document.getElementById(overlayId);
            overlay.classList.remove('visible');
        };
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeModal(overlay.id);
            });
        });


        // --- Polling Logic ---
        function stopPolling() {
            if (pollingTimeoutId) clearTimeout(pollingTimeoutId);
            pollingTimeoutId = null;
            dom.pollingStatus.classList.add('hidden');
        }

        function startPolling() {
            stopPolling();
            dom.pollingStatus.classList.remove('hidden');
            dom.pollingStatus.classList.add('flex');
            pollingTimeoutId = setTimeout(() => handleFetchWorkflow(true), 5000);
        }

        // --- Cytoscape Setup ---
        const cy = cytoscape({
            container: document.getElementById('cy'),
            style: [
                { selector: 'node', style: { 'background-color': '#1e293b', 'border-color': '#475569', 'border-width': 2, 'label': 'data(label)', 'color': '#e2e8f0', 'font-size': '12px', 'text-valign': 'center', 'text-halign': 'center', 'width': '140px', 'height': '50px', 'shape': 'round-rectangle', 'transition-property': 'background-color, border-color', 'transition-duration': '0.3s' } },
                { selector: 'edge', style: { 'width': 2, 'line-color': '#64748b', 'target-arrow-color': '#64748b', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier' } },
                { selector: 'node:selected', style: { 'border-color': '#818cf8', 'background-color': '#312e81' } },
                { selector: '.status-succeeded', style: { 'border-color': '#22c55e' } },
                { selector: '.status-running', style: { 'border-color': '#f59e0b', 'line-style': 'dashed', 'border-dash-pattern': [6, 3] } },
                { selector: '.status-failed', style: { 'border-color': '#ef4444' } },
                { selector: '.status-pending', style: { 'border-color': '#64748b' } },
            ],
            layout: { name: 'dagre' }
        });

        // --- API Calls ---
        async function handleFetchWorkflow(isPoll = false) {
            const workflowName = dom.workflowInput.value.trim();
            const namespace = dom.namespaceInput.value.trim();
            if (!workflowName || !namespace) return;

            if (!isPoll) {
                stopPolling();
                dom.fetchButton.textContent = "Fetching...";
                dom.fetchButton.disabled = true;
                dom.graphOverlay.classList.add('opacity-50');
            }

            const apiUrl = `http://127.0.0.1:3000/api/workflows/${workflowName}?namespace=${namespace}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server responded with ${response.status}. Message: ${errorText}`);
                }
                const newWorkflowData = await response.json();

                if (isPoll && currentWorkflow) {
                    // If polling, just update the graph nodes instead of re-rendering
                    updateGraph(newWorkflowData);
                } else {
                    // Initial fetch, render the full graph
                    dom.workflowNameDisplay.textContent = `${newWorkflowData.metadata.name} (in ${namespace})`;
                    dom.graphOverlay.classList.add('opacity-0', 'pointer-events-none');
                    dom.details.fetchPrompt.classList.add('hidden');
                    resetDetailsPanel();
                    renderGraph(newWorkflowData);
                }

                currentWorkflow = newWorkflowData; // Always update to the latest version
                startPolling();

            } catch (error) {
                console.error("Failed to fetch workflow:", error);
                stopPolling();
                if (!isPoll) {
                    showModal(dom.errorModal, 'Connection Failed', `<p>Could not fetch the workflow. Ensure the backend is running and the workflow name/namespace are correct.</p><p class="font-code text-sm mt-4"><strong>URL:</strong> ${apiUrl}</p><p class="font-code text-sm mt-2"><strong>Error:</strong> ${error.message}</p>`);
                }
            } finally {
                if (!isPoll) {
                    dom.fetchButton.textContent = "Fetch & Visualize";
                    dom.fetchButton.disabled = false;
                    dom.graphOverlay.classList.remove('opacity-50');
                }
            }
        }

        async function handleFetchResults(taskName) {
            if (!currentWorkflow) return;
            const { name, namespace } = currentWorkflow.metadata;
            const apiUrl = `http://127.0.0.1:3000/api/workflows/${namespace}/${name}/tasks/${taskName}/results`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server responded with ${response.status}. Message: ${errorText || 'No error message'}`);
                }
                const results = await response.json();

                dom.resultsModal.title.textContent = `Results for: ${taskName}`;

                let amplitudes = null;
                if (Array.isArray(results) && results.length > 0) {
                    const lastStep = results[results.length - 1];
                    if (lastStep && lastStep.finalStateVector && Array.isArray(lastStep.finalStateVector.amplitudes)) {
                        amplitudes = lastStep.finalStateVector.amplitudes;
                    }
                }

                switchResultTabs(!!amplitudes);

                if (amplitudes) {
                    renderStateVectorVisualization(amplitudes);
                } else {
                    dom.resultsModal.log.textContent = JSON.stringify(results, null, 2);
                }

                dom.resultsModal.overlay.classList.add('visible');

            } catch (error) {
                console.error("Failed to fetch results:", error);
                showModal(dom.errorModal, 'Failed to Fetch Results', `<p>Could not fetch results for task <strong>${taskName}</strong>.</p><p class="font-code text-sm mt-4"><strong>URL:</strong> ${apiUrl}</p><p class="font-code text-sm mt-2"><strong>Error:</strong> ${error.message}</p>`);
            }
        }

        async function handleQasmSubmit() {
            const name = dom.qasm.nameInput.value.trim();
            const namespace = dom.qasm.namespaceInput.value.trim();
            const qasm = dom.qasm.input.value.trim();

            if (!name || !namespace || !qasm) {
                showQasmNotification('Please fill in all fields.', 'error');
                return;
            }

            dom.qasm.submitButton.textContent = 'Submitting...';
            dom.qasm.submitButton.disabled = true;

            const apiUrl = `http://127.0.0.1:3000/api/workflows/${namespace}/${name}/qasm`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: qasm
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server responded with ${response.status}. Message: ${errorText}`);
                }

                const result = await response.json();
                showQasmNotification(`Workflow "${result.metadata.name}" created successfully! Redirecting...`, 'success');

                setTimeout(() => {
                    dom.workflowInput.value = name;
                    dom.namespaceInput.value = namespace;
                    showPage('visualizer');
                    handleFetchWorkflow(false);
                    dom.qasm.notification.classList.add('hidden');
                }, 2000);

            } catch (error) {
                showQasmNotification(`Error: ${error.message}`, 'error');
            } finally {
                dom.qasm.submitButton.textContent = 'Submit Workflow';
                dom.qasm.submitButton.disabled = false;
            }
        }

        function showQasmNotification(message, type = 'success') {
            const notification = dom.qasm.notification;
            notification.textContent = message;
            notification.className = 'p-4 mb-4 rounded-md'; // Reset classes
            if (type === 'success') {
                notification.classList.add('bg-green-500/20', 'text-green-300');
            } else {
                notification.classList.add('bg-red-500/20', 'text-red-300');
            }
            notification.classList.remove('hidden');
        }


        // --- Rendering Logic ---
        function renderGraph(workflow) {
            const elements = [];
            const tasks = workflow.spec.tasks || [];

            tasks.forEach(task => {
                const taskStatus = (workflow.status?.taskStatus?.[task.name] || 'Pending').toLowerCase();
                elements.push({
                    group: 'nodes',
                    data: { id: task.name, label: task.name, status: taskStatus, rawData: task },
                    classes: `status-${taskStatus}`
                });
                if (task.dependsOn) {
                    task.dependsOn.forEach(dep => {
                        elements.push({ group: 'edges', data: { id: `${dep}->${task.name}`, source: dep, target: task.name } });
                    });
                }
            });

            cy.elements().remove();
            cy.add(elements);
            cy.layout({ name: 'dagre', nodeSep: 60, rankSep: 80, spacingFactor: 1.2, rankDir: 'TB' }).run();
            cy.fit(30);
        }

        function updateGraph(newWorkflow) {
            const newStatuses = newWorkflow.status?.taskStatus || {};
            const oldStatuses = currentWorkflow.status?.taskStatus || {};
            const selectedNode = cy.$('node:selected');
            const selectedNodeId = selectedNode.id();
            let selectedNodeStatusChanged = false;

            for (const taskName in newStatuses) {
                const newStatus = newStatuses[taskName].toLowerCase();
                const oldStatus = (oldStatuses[taskName] || 'pending').toLowerCase();

                if (newStatus !== oldStatus) {
                    const node = cy.getElementById(taskName);
                    if (node.length) {
                        node.removeClass(`status-${oldStatus}`)
                            .addClass(`status-${newStatus}`)
                            .data('status', newStatus);

                        if (taskName === selectedNodeId) {
                            selectedNodeStatusChanged = true;
                        }
                    }
                }
            }

            if (selectedNodeStatusChanged) {
                const updatedTaskData = newWorkflow.spec.tasks.find(t => t.name === selectedNodeId);
                if(updatedTaskData) {
                    selectedNode.data('rawData', updatedTaskData);
                    displayTaskDetails(selectedNode);
                }
            }
        }

        function resetDetailsPanel() {
            dom.details.content.style.opacity = '0';
            setTimeout(() => {
                dom.details.title.textContent = 'Select a Task';
                dom.details.placeholder.classList.remove('hidden');
                dom.details.data.classList.add('hidden');
                cy.elements().unselect();
                dom.details.content.style.opacity = '1';
            }, 150);
        }

        function displayTaskDetails(node) {
            const task = node.data('rawData');
            const status = node.data('status');

            dom.details.content.style.opacity = '0';

            setTimeout(() => {
                dom.details.placeholder.classList.add('hidden');
                dom.details.data.classList.remove('hidden');
                dom.details.title.textContent = task.name;
                dom.details.status.textContent = status.charAt(0).toUpperCase() + status.slice(1);

                const isQuantum = task.quantum;
                dom.details.circuitTitle.textContent = isQuantum ? "Quantum Circuit (OpenQASM)" : "Classical Command";
                dom.details.circuit.textContent = isQuantum ? task.quantum.circuit : (task.classical?.command || 'N/A');
                dom.details.params.textContent = JSON.stringify(isQuantum ? task.quantum.params : (task.classical?.params || {}), null, 2);

                dom.details.resultsBtnContainer.innerHTML = '';
                if (status === 'succeeded') {
                    const button = document.createElement('button');
                    button.textContent = 'View Results';
                    button.className = 'btn btn-success w-full';
                    button.onclick = () => handleFetchResults(task.name);
                    dom.details.resultsBtnContainer.appendChild(button);
                }
                dom.details.content.style.opacity = '1';
            }, 150);
        }

        function renderStateVectorVisualization(amplitudes) {
            const visElement = dom.resultsModal.vis;
            d3.select(visElement).selectAll("*").remove();

            if (visElement.clientWidth === 0) {
                setTimeout(() => renderStateVectorVisualization(amplitudes), 100);
                return;
            }

            const data = amplitudes.map((amp, i) => ({
                state: i,
                probability: (amp[0] * amp[0]) + (amp[1] * amp[1])
            }));

            const numQubits = Math.log2(data.length);
            if (numQubits % 1 !== 0) {
                visElement.innerHTML = `<p class="text-red-400 p-4">Error: Invalid state vector length (${data.length}). Must be a power of 2.</p>`;
                return;
            }

            const margin = {top: 20, right: 20, bottom: 60, left: 60};
            const width = visElement.clientWidth - margin.left - margin.right;
            const height = visElement.clientHeight - margin.top - margin.bottom;

            const svg = d3.select(visElement).append("svg")
                .attr("width", "100%").attr("height", "100%")
                .attr("viewBox", `0 0 ${visElement.clientWidth} ${visElement.clientHeight}`)
                .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(d => `|${d.state.toString(2).padStart(numQubits, '0')}⟩`))
                .padding(0.2);

            svg.append("g")
                .attr("transform", `translate(0,${height})`).call(d3.axisBottom(x))
                .selectAll("text")
                .attr("class", "vis-axis").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end");

            const y = d3.scaleLinear().domain([0, 1]).range([height, 0]);

            svg.append("g").call(d3.axisLeft(y).ticks(5).tickFormat(d3.format(".0%"))).selectAll("text").attr("class", "vis-axis");

            svg.append("text")
                .attr("transform", "rotate(-90)").attr("y", 0 - margin.left).attr("x",0 - (height / 2))
                .attr("dy", "1em").style("text-anchor", "middle").attr("class", "vis-axis").text("Probability");

            svg.append("g").attr("class", "vis-grid").call(d3.axisLeft(y).ticks(5).tickSize(-width).tickFormat(""));

            svg.selectAll("mybar").data(data).join("rect")
                .attr("class", "vis-bar")
                .attr("x", d => x(`|${d.state.toString(2).padStart(numQubits, '0')}⟩`))
                .attr("y", d => y(d.probability))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.probability))
                .append("title").text(d => `State: |${d.state.toString(2).padStart(numQubits, '0')}⟩\nProbability: ${(d.probability * 100).toFixed(3)}%`);
        }

        function switchResultTabs(showVis) {
            const activeClasses = ['border-indigo-500', 'text-indigo-400'];
            const inactiveClasses = ['border-transparent', 'text-slate-400', 'hover:text-slate-300', 'hover:border-slate-400'];

            dom.resultsModal.tabVis.classList.remove(...(showVis ? inactiveClasses : activeClasses));
            dom.resultsModal.tabVis.classList.add(...(showVis ? activeClasses : inactiveClasses));
            dom.resultsModal.tabLog.classList.remove(...(!showVis ? inactiveClasses : activeClasses));
            dom.resultsModal.tabLog.classList.add(...(!showVis ? activeClasses : inactiveClasses));

            dom.resultsModal.visContainer.classList.toggle('hidden', !showVis);
            dom.resultsModal.logContainer.classList.toggle('hidden', showVis);
        }

        // --- Event Listeners ---
        dom.fetchButton.addEventListener('click', () => handleFetchWorkflow(false));
        dom.workflowInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleFetchWorkflow(false); });
        dom.namespaceInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleFetchWorkflow(false); });
        cy.on('tap', 'node', (evt) => displayTaskDetails(evt.target));
        cy.on('tap', (evt) => {
            if (evt.target === cy) resetDetailsPanel();
        });

        dom.resultsModal.tabVis.addEventListener('click', (e) => { e.preventDefault(); switchResultTabs(true); });
        dom.resultsModal.tabLog.addEventListener('click', (e) => { e.preventDefault(); switchResultTabs(false); });

        dom.nav.visualizer.addEventListener('click', (e) => { e.preventDefault(); showPage('visualizer'); });
        dom.nav.submitter.addEventListener('click', (e) => { e.preventDefault(); showPage('submitter'); });

        dom.qasm.submitButton.addEventListener('click', handleQasmSubmit);
    });
</script>
</body>
</html>
