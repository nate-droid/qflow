<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live QuantumWorkflow Visualizer</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; color: #e5e7eb; }
        .font-code { font-family: 'Fira Code', monospace; }
        #cy { height: 100%; width: 100%; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7);
            display: none; align-items: center; justify-content: center; z-index: 100;
        }
        .modal-content {
            background-color: #1f2937; color: #d1d5db; padding: 2rem;
            border-radius: 0.5rem; border: 1px solid #4b5563;
            width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;
        }
        .modal-content h2 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; }
        .modal-content pre { background-color: #111827; padding: 1rem; border-radius: 0.25rem; font-size: 0.875rem; overflow-x: auto; }
        .modal-content code { color: #93c5fd; }
        .modal-content p { margin-bottom: 1rem; }
        .modal-content strong { color: white; font-weight: 600; }
        .modal-close-btn {
            position: absolute; top: 1rem; right: 1rem; color: #9ca3af;
            cursor: pointer; background: none; border: none; font-size: 1.5rem;
        }
        .modal-close-btn:hover { color: white; }

        .input-group { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .input-group input { background-color: #374151; border: 1px solid #4b5563; color: white; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; }
        .fetch-button { background-color: #4f46e5; color: white; font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem; width: 100%; text-align: center; cursor: pointer; }
        .fetch-button:hover { background-color: #4338ca; }
        .results-button { background-color: #16a34a; color: white; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.375rem; text-align: center; cursor: pointer; margin-top: 1rem; }
        .results-button:hover { background-color: #15803d; }

        #q-state-vis-container {
            background-color: #111827;
            border-radius: 0.5rem;
            padding: 1.5rem 1rem 1rem 0;
        }
        .vis-bar { fill: #38bdf8; transition: fill 0.2s; }
        .vis-bar:hover { fill: #0ea5e9; }
        .vis-axis path, .vis-axis line { stroke: #4b5563; }
        .vis-axis text { fill: #9ca3af; font-family: 'Fira Code', monospace; }
        .vis-grid line { stroke: #374151; stroke-opacity: 0.7; shape-rendering: crispEdges; }
        .vis-grid path { stroke-width: 0; }

    </style>
</head>
<body class="h-full antialiased">
<div class="flex flex-col h-screen">
    <!-- Header -->
    <header class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 p-4 shadow-lg z-20 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-white">QuantumWorkflow Visualizer</h1>
            <p class="text-sm text-gray-400">Status: <span class="font-semibold text-cyan-400" id="workflow-name-display">Idle</span></p>
        </div>
        <div id="polling-status" class="text-sm text-gray-400 hidden">
            <span class="animate-pulse">â—‰</span> Polling for updates...
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
        <div id="cy-container" class="flex-1 relative">
            <div id="cy"></div>
            <div id="graph-overlay" class="absolute inset-0 bg-gray-900/80 flex items-center justify-center z-30">
                <div class="w-full max-w-md p-4">
                    <h2 class="text-2xl font-bold text-center text-white mb-4">Fetch a Workflow</h2>
                    <div class="input-group">
                        <input type="text" id="workflow-input" placeholder="Workflow Name" value="my-quantum-workflow">
                        <input type="text" id="namespace-input" placeholder="Namespace" value="default">
                    </div>
                    <button id="fetch-button" class="fetch-button">Fetch Workflow</button>
                </div>
            </div>
        </div>
        <aside id="details-panel" class="w-full md:w-1/3 lg:w-1/4 bg-gray-800/80 backdrop-blur-sm border-l border-gray-700 flex flex-col">
            <div class="p-6 overflow-y-auto flex-1">
                <h2 id="details-title" class="text-lg font-bold text-white mb-4">Select a Task</h2>
                <p id="details-placeholder" class="text-gray-400">Fetch a workflow to begin.</p>
                <div id="details-data" class="hidden space-y-4">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-400 mb-2">Status</h3>
                        <p id="details-status" class="font-code text-sm"></p>
                    </div>
                    <div>
                        <h3 id="details-circuit-title" class="text-sm font-semibold text-gray-400 mb-2">Circuit</h3>
                        <pre class="bg-gray-900 rounded-lg p-4 text-sm font-code text-cyan-300 overflow-x-auto"><code id="details-circuit"></code></pre>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-400 mb-2">Parameters</h3>
                        <pre class="bg-gray-900 rounded-lg p-4 text-sm font-code text-yellow-300 overflow-x-auto"><code id="details-params"></code></pre>
                    </div>
                    <div id="results-button-container"></div>
                </div>
            </div>
        </aside>
    </main>
</div>

<!-- Modals -->
<div id="error-modal-overlay" class="modal-overlay">
    <div id="error-modal-content" class="modal-content" onclick="event.stopPropagation()"></div>
</div>
<div id="results-modal-overlay" class="modal-overlay">
    <div id="results-modal-content" class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close-btn" onclick="closeModal('results-modal-overlay')">&times;</button>
        <h2 id="results-modal-title" class="text-cyan-400">Task Results</h2>
        <div id="q-state-vis-container" class="mb-6 hidden">
            <h3 class="text-sm font-semibold text-gray-400 mb-2">State Vector Probabilities</h3>
            <div id="q-state-vis" class="w-full h-64"></div>
        </div>
        <div id="raw-log-container" class="hidden">
            <h3 class="text-sm font-semibold text-gray-400 mb-2">Full Execution Log</h3>
            <pre><code id="results-modal-log" class="font-code"></code></pre>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Globals ---
        let currentWorkflow = null;
        let pollingTimeoutId = null;

        // --- DOM Elements ---
        const dom = {
            graphOverlay: document.getElementById('graph-overlay'),
            fetchButton: document.getElementById('fetch-button'),
            workflowInput: document.getElementById('workflow-input'),
            namespaceInput: document.getElementById('namespace-input'),
            workflowNameDisplay: document.getElementById('workflow-name-display'),
            pollingStatus: document.getElementById('polling-status'),
            details: {
                placeholder: document.getElementById('details-placeholder'),
                data: document.getElementById('details-data'),
                title: document.getElementById('details-title'),
                status: document.getElementById('details-status'),
                circuitTitle: document.getElementById('details-circuit-title'),
                circuit: document.getElementById('details-circuit'),
                params: document.getElementById('details-params'),
                resultsBtnContainer: document.getElementById('results-button-container'),
            },
            errorModal: {
                overlay: document.getElementById('error-modal-overlay'),
                content: document.getElementById('error-modal-content'),
            },
            resultsModal: {
                overlay: document.getElementById('results-modal-overlay'),
                content: document.getElementById('results-modal-content'),
                title: document.getElementById('results-modal-title'),
                logContainer: document.getElementById('raw-log-container'),
                log: document.getElementById('results-modal-log'),
                visContainer: document.getElementById('q-state-vis-container'),
                vis: document.getElementById('q-state-vis'),
            }
        };

        // --- Modal Logic ---
        function showModal(modal, title, content) {
            modal.content.innerHTML = `
                <button class="modal-close-btn" onclick="closeModal('${modal.overlay.id}')">&times;</button>
                <h2 style="color: #fca5a5;">${title}</h2>
                <div>${content}</div>`;
            modal.overlay.style.display = 'flex';
        }
        window.closeModal = (overlayId) => {
            document.getElementById(overlayId).style.display = 'none';
        }
        dom.errorModal.overlay.addEventListener('click', (e) => {
            if (e.target === dom.errorModal.overlay) closeModal(dom.errorModal.overlay.id);
        });
        dom.resultsModal.overlay.addEventListener('click', (e) => {
            if (e.target === dom.resultsModal.overlay) closeModal(dom.resultsModal.overlay.id);
        });

        // --- Polling Logic ---
        function stopPolling() {
            if (pollingTimeoutId) clearTimeout(pollingTimeoutId);
            pollingTimeoutId = null;
            dom.pollingStatus.classList.add('hidden');
        }

        function startPolling() {
            stopPolling();
            dom.pollingStatus.classList.remove('hidden');
            pollingTimeoutId = setTimeout(() => handleFetchWorkflow(true), 5000);
        }

        // --- Cytoscape Setup ---
        const cy = cytoscape({
            container: document.getElementById('cy'),
            style: [
                { selector: 'node', style: { 'background-color': '#1f2937', 'border-color': '#4b5563', 'border-width': 2, 'label': 'data(label)', 'color': '#e5e7eb', 'font-size': '12px', 'text-valign': 'center', 'text-halign': 'center', 'width': '140px', 'height': '50px', 'shape': 'round-rectangle', 'transition-property': 'background-color, border-color', 'transition-duration': '0.3s' } },
                { selector: 'edge', style: { 'width': 2, 'line-color': '#6b7280', 'target-arrow-color': '#6b7280', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier' } },
                { selector: 'node:selected', style: { 'border-color': '#38bdf8', 'background-color': '#075985' } },
                { selector: '.status-succeeded', style: { 'border-color': '#22c55e' } },
                { selector: '.status-running', style: { 'border-color': '#f59e0b', 'line-style': 'dashed', 'border-dash-pattern': [6, 3] } },
                { selector: '.status-failed', style: { 'border-color': '#ef4444' } },
                { selector: '.status-pending', style: { 'border-color': '#6b7280' } },
            ],
            layout: { name: 'dagre' }
        });

        // --- API Calls ---
        async function handleFetchWorkflow(isPoll = false) {
            const workflowName = dom.workflowInput.value.trim();
            const namespace = dom.namespaceInput.value.trim();
            if (!workflowName || !namespace) return;

            if (!isPoll) {
                stopPolling();
                dom.graphOverlay.style.display = 'flex';
            }

            const apiUrl = `http://localhost:3000/api/workflows/${workflowName}?namespace=${namespace}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server responded with ${response.status}. Message: ${errorText}`);
                }
                currentWorkflow = await response.json();

                dom.workflowNameDisplay.textContent = `${currentWorkflow.metadata.name} (in ${namespace})`;
                dom.graphOverlay.style.display = 'none';
                renderGraph(currentWorkflow);
                startPolling();
            } catch (error) {
                console.error("Failed to fetch workflow:", error);
                stopPolling();
                if (!isPoll) {
                    dom.graphOverlay.style.display = 'flex';
                    showModal(dom.errorModal, 'Connection Failed', `<p>Could not fetch the workflow. Ensure the backend is running and the workflow name/namespace are correct.</p><p><strong>URL Attempted:</strong> ${apiUrl}</p><p><strong>Error:</strong> ${error.message}</p>`);
                }
            }
        }

        async function handleFetchResults(taskName) {
            if (!currentWorkflow) return;
            const { name, namespace } = currentWorkflow.metadata;
            const apiUrl = `http://localhost:3000/api/workflows/${namespace}/${name}/tasks/${taskName}/results`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                const results = await response.json();

                dom.resultsModal.title.textContent = `Results for: ${taskName}`;

                // FIX: Correctly look for the amplitudes array inside the finalStateVector object.
                let amplitudes = null;
                if (Array.isArray(results) && results.length > 0) {
                    const lastStep = results[results.length - 1];
                    if (lastStep && lastStep.finalStateVector && Array.isArray(lastStep.finalStateVector.amplitudes)) {
                        amplitudes = lastStep.finalStateVector.amplitudes;
                    }
                }

                if (amplitudes) {
                    dom.resultsModal.visContainer.classList.remove('hidden');
                    dom.resultsModal.logContainer.classList.add('hidden');
                } else {
                    dom.resultsModal.visContainer.classList.add('hidden');
                    dom.resultsModal.logContainer.classList.remove('hidden');
                    dom.resultsModal.log.textContent = JSON.stringify(results, null, 2);
                }

                dom.resultsModal.overlay.style.display = 'flex';

                if (amplitudes) {
                    renderStateVectorVisualization(amplitudes);
                }

            } catch (error) {
                console.error("Failed to fetch results:", error);
                showModal(dom.errorModal, 'Failed to Fetch Results', `<p>Could not fetch results for task <strong>${taskName}</strong>.</p><p><strong>URL Attempted:</strong> ${apiUrl}</p><p><strong>Error:</strong> ${error.message}</p>`);
            }
        }

        // --- Rendering Logic ---
        function renderGraph(workflow) {
            const elements = [];
            const tasks = workflow.spec.tasks || [];

            tasks.forEach(task => {
                const taskStatus = (workflow.status?.taskStatus?.[task.name] || 'Pending').toLowerCase();
                elements.push({
                    group: 'nodes',
                    data: { id: task.name, label: task.name, status: taskStatus, rawData: task },
                    classes: `status-${taskStatus}`
                });
                if (task.dependsOn) {
                    task.dependsOn.forEach(dep => {
                        elements.push({ group: 'edges', data: { id: `${dep}->${task.name}`, source: dep, target: task.name } });
                    });
                }
            });

            cy.elements().remove();
            cy.add(elements);
            cy.layout({ name: 'dagre', nodeSep: 60, rankSep: 80, spacingFactor: 1.2, rankDir: 'TB' }).run();
            cy.fit(30);
        }

        function displayTaskDetails(node) {
            const task = node.data('rawData');
            const status = node.data('status');

            dom.details.placeholder.classList.add('hidden');
            dom.details.data.classList.remove('hidden');
            dom.details.title.textContent = task.name;
            dom.details.status.textContent = status.charAt(0).toUpperCase() + status.slice(1);

            const isQuantum = task.quantum;
            dom.details.circuitTitle.textContent = isQuantum ? "Quantum Circuit (OpenQASM)" : "Task Details";
            dom.details.circuit.textContent = isQuantum ? task.quantum.circuit : (task.classical?.command || 'N/A');
            dom.details.params.textContent = JSON.stringify(isQuantum ? task.quantum.params : task.classical?.params, null, 2) || 'N/A';

            dom.details.resultsBtnContainer.innerHTML = '';
            if (status === 'succeeded') {
                const button = document.createElement('button');
                button.textContent = 'View Results';
                button.className = 'results-button';
                button.onclick = () => handleFetchResults(task.name);
                dom.details.resultsBtnContainer.appendChild(button);
            }
        }

        function renderStateVectorVisualization(amplitudes) {
            const visElement = dom.resultsModal.vis;
            d3.select(visElement).selectAll("*").remove();

            if (visElement.clientWidth === 0) {
                setTimeout(() => renderStateVectorVisualization(amplitudes), 100);
                return;
            }

            // FIX: Correctly parse the [real, imaginary] pairs from the amplitudes array.
            const data = amplitudes.map((amp, i) => {
                const real = amp[0];
                const imag = amp[1];
                return {
                    state: i,
                    probability: (real * real) + (imag * imag)
                };
            });

            const numQubits = Math.log2(data.length);
            if (numQubits % 1 !== 0) {
                visElement.innerHTML = `<p class="text-red-400 p-4">Error: Invalid state vector length (${data.length}). Must be a power of 2.</p>`;
                return;
            }

            const margin = {top: 20, right: 20, bottom: 50, left: 50};
            const width = visElement.clientWidth - margin.left - margin.right;
            const height = visElement.clientHeight - margin.top - margin.bottom;

            const svg = d3.select(visElement)
                .append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("viewBox", `0 0 ${visElement.clientWidth} ${visElement.clientHeight}`)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(d => `|${d.state.toString(2).padStart(numQubits, '0')}âŸ©`))
                .padding(0.2);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("class", "vis-axis")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            const y = d3.scaleLinear()
                .domain([0, 1])
                .range([height, 0]);

            svg.append("g")
                .call(d3.axisLeft(y).ticks(5).tickFormat(d3.format(".1%")))
                .selectAll("text")
                .attr("class", "vis-axis");

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x",0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .attr("class", "vis-axis")
                .text("Probability");

            svg.append("g")
                .attr("class", "vis-grid")
                .call(d3.axisLeft(y).ticks(5).tickSize(-width).tickFormat(""));

            svg.selectAll("mybar")
                .data(data)
                .join("rect")
                .attr("class", "vis-bar")
                .attr("x", d => x(`|${d.state.toString(2).padStart(numQubits, '0')}âŸ©`))
                .attr("y", d => y(d.probability))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.probability))
                .append("title")
                .text(d => `Probability: ${(d.probability * 100).toFixed(2)}%`);
        }

        // --- Event Listeners ---
        dom.fetchButton.addEventListener('click', () => handleFetchWorkflow(false));
        cy.on('tap', 'node', (evt) => displayTaskDetails(evt.target));
        cy.on('tap', (evt) => {
            if (evt.target === cy) {
                dom.details.title.textContent = 'Select a Task';
                dom.details.placeholder.classList.remove('hidden');
                dom.details.data.classList.add('hidden');
                cy.elements().unselect();
            }
        });
    });
</script>
</body>
</html>
